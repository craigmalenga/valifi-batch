<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Valifi Batch Runner (Mirror)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f4f6fb;
            margin: 0;
            padding: 20px;
            color: #222;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
            padding: 24px 28px 32px;
        }
        h1 { margin: 0 0 8px; font-size: 24px; }
        .subtitle { margin: 0 0 24px; color: #555; font-size: 13px; }
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .warning-box strong { color: #92400e; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        .card {
            border-radius: 12px;
            border: 1px solid #e3e6f0;
            padding: 16px 18px;
            background: #fafbff;
        }
        .card h2 { font-size: 16px; margin: 0 0 12px; }
        label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: #444;
        }
        input[type="text"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d0d4e0;
            font-size: 13px;
            outline: none;
        }
        input:focus {
            border-color: #4c6fff;
            box-shadow: 0 0 0 1px rgba(76,111,255,0.12);
        }
        .field { margin-bottom: 10px; }
        .field-inline { display: flex; gap: 8px; }
        .field-inline > div { flex: 1; }
        .file-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 14px;
            background: #4c6fff;
            color: #fff;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border: none;
            margin-bottom: 8px;
        }
        #csvFile { display: none; }
        .file-info { font-size: 11px; color: #555; margin-bottom: 10px; }
        button.action {
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        button.primary { background: #1ea672; color: #fff; }
        button.secondary { background: #e4e7f5; color: #222; }
        button.danger { background: #dc2626; color: #fff; }
        button.action:disabled { opacity: 0.4; cursor: default; }
        #log {
            background: #050816;
            color: #e5e7eb;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-family: Menlo, Monaco, Consolas, monospace;
            font-size: 12px;
            border-radius: 10px;
            margin-top: 6px;
            white-space: pre-wrap;
        }
        #previewTable, #resultsTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        #previewTable th, #previewTable td,
        #resultsTable th, #resultsTable td {
            border: 1px solid #e2e4f0;
            padding: 4px 6px;
            text-align: left;
        }
        #previewTable th, #resultsTable th {
            background: #f4f6ff;
            font-weight: 600;
        }
        .preview-container {
            max-height: 250px;
            overflow: auto;
        }
        .small { font-size: 11px; color: #666; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid;
            margin-right: 4px;
        }
        .badge-ok { border-color: #16a34a; color: #166534; background: #dcfce7; }
        .badge-error { border-color: #dc2626; color: #7f1d1d; background: #fee2e2; }
        .badge-skip { border-color: #ca8a04; color: #854d0e; background: #fef9c3; }
        code {
            background: #f1f5f9;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Valifi Batch Runner (Mirror)</h1>
        <p class="subtitle">
            Private CSV ‚Üí <code>/query</code> ‚Üí <code>/upload_summary</code> tool for your mirror app.<br>
            Uses <code>skipFLG: true</code> to generate fake Lead IDs without hitting FLG API.
        </p>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Mirror Mode:</strong> This tool creates ClaimTracking records with fake Lead IDs. 
            No actual FLG API calls will be made. Data will be stored in your database for later processing.
        </div>

        <div class="grid">
            <!-- Left: Config + Upload -->
            <div class="card">
                <h2>1. Configuration</h2>
                <div class="field">
                    <label for="baseUrl">Backend Base URL (mirror app)</label>
                    <input id="baseUrl" type="text" value="https://valifi-batch.up.railway.app" placeholder="https://your-mirror-app.railway.app">
                </div>
                <div class="field-inline">
                    <div>
                        <label for="delayMs">Delay between records (ms)</label>
                        <input id="delayMs" type="number" value="1500" min="500">
                    </div>
                    <div>
                        <label for="maxRecords">Max records (0 = all)</label>
                        <input id="maxRecords" type="number" value="0" min="0">
                    </div>
                </div>
                
                <hr style="margin: 14px 0; border: none; border-top: 1px solid #e1e4f0;">
                
                <h2>2. CSV Upload</h2>
                <label class="file-label" for="csvFile">üìÑ Choose CSV File</label>
                <input id="csvFile" type="file" accept=".csv">
                <div class="file-info" id="fileInfo">No file chosen.</div>
                
                <button id="runBatchBtn" class="action primary" disabled>‚ñ∂ Run Batch</button>
                <button id="stopBtn" class="action danger" disabled>‚èπ Stop</button>
                
                <p class="small" style="margin-top: 12px;">
                    <strong>Required CSV columns:</strong><br>
                    <code>first_name</code>, <code>last_name</code>, <code>email</code>, <code>mobile</code>,
                    <code>dob_day</code>, <code>dob_month</code>, <code>dob_year</code>,
                    <code>street</code>, <code>post_town</code>, <code>post_code</code><br><br>
                    <strong>Optional:</strong><br>
                    <code>title</code>, <code>middle_name</code>, <code>flat</code>, <code>building_name</code>, 
                    <code>building_number</code>, <code>district</code>, <code>county</code>,
                    <code>prev1_*</code>, <code>prev2_*</code> (previous addresses)
                </p>
            </div>

            <!-- Right: Preview -->
            <div class="card">
                <h2>3. CSV Preview</h2>
                <div id="previewContainer" class="preview-container small">No data loaded.</div>
            </div>
        </div>

        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <h2>4. Log</h2>
                <div id="log"></div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>5. Results</h2>
            <div id="resultsContainer" class="small">No results yet.</div>
        </div>
    </div>

    <script>
    // ===== State =====
    let records = [];
    let stopRequested = false;
    let isRunning = false;

    // ===== Utilities =====
    function log(msg, level = "info") {
        const el = document.getElementById("log");
        const ts = new Date().toISOString().split("T")[1].slice(0, 8);
        const prefix = level === "error" ? "‚ùå" : level === "warn" ? "‚ö†Ô∏è" : level === "success" ? "‚úÖ" : "‚ÑπÔ∏è";
        el.textContent += `[${ts}] ${prefix} ${msg}\n`;
        el.scrollTop = el.scrollHeight;
    }

    function clearLog() {
        document.getElementById("log").textContent = "";
    }

    function formatDateYYYYMMDD(record) {
        const y = (record.dob_year || "").toString().trim();
        const m = (record.dob_month || "").toString().trim().padStart(2, "0");
        const d = (record.dob_day || "").toString().trim().padStart(2, "0");
        if (y && m && d && y.length === 4) {
            return `${y}-${m}-${d}`;
        }
        return "";
    }

    function buildPreviousAddress(record, prefix) {
        const postCode = (record[`${prefix}_post_code`] || "").trim();
        if (!postCode) return null;
        
        return {
            flat: (record[`${prefix}_flat`] || "").trim(),
            building_name: (record[`${prefix}_building_name`] || "").trim(),
            building_number: (record[`${prefix}_building_number`] || "").trim(),
            street: (record[`${prefix}_street`] || "").trim(),
            district: (record[`${prefix}_district`] || "").trim(),
            county: (record[`${prefix}_county`] || "").trim(),
            post_town: (record[`${prefix}_post_town`] || "").trim(),
            post_code: postCode
        };
    }

    function extractAccounts(valifiResponse) {
        // Try multiple paths where accounts might be
        if (valifiResponse?.data?.summaryReportV2?.accounts) {
            return valifiResponse.data.summaryReportV2.accounts;
        }
        if (valifiResponse?.data?.accounts) {
            return valifiResponse.data.accounts;
        }
        if (valifiResponse?.data?.summaryReport?.accounts) {
            return valifiResponse.data.summaryReport.accounts;
        }
        return [];
    }

    function extractPdfUrl(valifiResponse) {
        return valifiResponse?.data?.pdfUrl || "";
    }

    // ===== CSV Handling =====
    document.getElementById("csvFile").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        document.getElementById("fileInfo").textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                records = results.data.filter(r => r.first_name && r.last_name);
                log(`Loaded ${records.length} valid records from CSV`);
                renderPreview(records);
                document.getElementById("runBatchBtn").disabled = records.length === 0;
            },
            error: function(err) {
                log(`CSV parse error: ${err.message}`, "error");
            }
        });
    });

    function renderPreview(data) {
        const container = document.getElementById("previewContainer");
        if (!data.length) {
            container.textContent = "No valid records found.";
            return;
        }
        
        const cols = ["first_name", "last_name", "email", "mobile", "dob_day", "dob_month", "dob_year", "post_code"];
        let html = `<table id="previewTable"><thead><tr><th>#</th>`;
        cols.forEach(c => html += `<th>${c}</th>`);
        html += `</tr></thead><tbody>`;
        
        data.slice(0, 50).forEach((row, idx) => {
            html += `<tr><td>${idx + 1}</td>`;
            cols.forEach(c => html += `<td>${row[c] || ""}</td>`);
            html += `</tr>`;
        });
        
        html += `</tbody></table>`;
        if (data.length > 50) {
            html += `<p class="small">Showing first 50 of ${data.length} records.</p>`;
        }
        container.innerHTML = html;
    }

    // ===== Batch Processing =====
    async function runBatch() {
        if (isRunning) return;
        
        const baseUrl = document.getElementById("baseUrl").value.trim().replace(/\/$/, "");
        if (!baseUrl) {
            alert("Please enter the backend base URL");
            return;
        }
        
        const delayMs = parseInt(document.getElementById("delayMs").value) || 1500;
        const maxRecords = parseInt(document.getElementById("maxRecords").value) || 0;
        const limit = maxRecords > 0 ? Math.min(maxRecords, records.length) : records.length;
        
        isRunning = true;
        stopRequested = false;
        document.getElementById("runBatchBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
        
        clearLog();
        log(`Starting batch processing: ${limit} records`);
        log(`Base URL: ${baseUrl}`);
        log(`Delay: ${delayMs}ms between records`);
        log(`skipFLG: true (no FLG API calls)`);
        log("‚îÄ".repeat(50));
        
        const results = [];
        const campaign = `batch_import_${new Date().toISOString().split("T")[0]}`;
        
        for (let i = 0; i < limit; i++) {
            if (stopRequested) {
                log("Batch stopped by user", "warn");
                break;
            }
            
            const record = records[i];
            const idxLabel = i + 1;
            const dateOfBirth = formatDateYYYYMMDD(record);
            
            log(`[${idxLabel}/${limit}] Processing: ${record.first_name} ${record.last_name}`);
            
            // Validate required fields
            if (!record.first_name || !record.last_name || !dateOfBirth || !record.post_code) {
                log(`[${idxLabel}] ‚è≠Ô∏è Skipping - missing required fields`, "warn");
                results.push({
                    index: idxLabel,
                    first_name: record.first_name || "",
                    last_name: record.last_name || "",
                    status: "SKIPPED",
                    error: "Missing required fields"
                });
                continue;
            }
            
            try {
                // ===== Step 1: Call /query =====
                const queryPayload = {
                    firstName: (record.first_name || "").trim(),
                    lastName: (record.last_name || "").trim(),
                    middleName: (record.middle_name || "").trim(),
                    title: (record.title || "").trim(),
                    dateOfBirth: dateOfBirth,
                    flat: (record.flat || "").trim(),
                    building_name: (record.building_name || "").trim(),
                    building_number: (record.building_number || "").trim(),
                    street: (record.street || "").trim(),
                    district: (record.district || "").trim(),
                    county: (record.county || "").trim(),
                    post_town: (record.post_town || "").trim(),
                    post_code: (record.post_code || "").trim(),
                    previousAddress: buildPreviousAddress(record, "prev1"),
                    previousPreviousAddress: buildPreviousAddress(record, "prev2")
                };
                
                log(`[${idxLabel}] ‚Üí Calling /query...`);
                
                const queryResp = await fetch(`${baseUrl}/query`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(queryPayload)
                });
                
                if (!queryResp.ok) {
                    const errText = await queryResp.text();
                    throw new Error(`/query failed: ${queryResp.status} - ${errText}`);
                }
                
                // IMPORTANT: /query returns RAW Valifi response (not wrapped)
                const valifiResponse = await queryResp.json();
                const accounts = extractAccounts(valifiResponse);
                const pdfUrl = extractPdfUrl(valifiResponse);
                
                log(`[${idxLabel}] ‚Üê Found ${accounts.length} accounts, PDF: ${pdfUrl ? "Yes" : "No"}`);
                
                // ===== Step 2: Build summary for /upload_summary =====
                const mobile = (record.mobile || "").trim();
                const ukMobile = mobile.startsWith("44") ? "0" + mobile.substring(2) : mobile;
                
                const summary = {
                    // Identity
                    firstName: queryPayload.firstName,
                    lastName: queryPayload.lastName,
                    middleName: queryPayload.middleName,
                    title: queryPayload.title,
                    dateOfBirth: dateOfBirth,
                    
                    // Contact
                    email: (record.email || "").trim(),
                    mobile: ukMobile,
                    phone1: ukMobile,
                    
                    // Address (multiple key formats for compatibility)
                    flat: queryPayload.flat,
                    building_name: queryPayload.building_name,
                    building_number: queryPayload.building_number,
                    street: queryPayload.street,
                    district: queryPayload.district,
                    county: queryPayload.county,
                    post_town: queryPayload.post_town,
                    towncity: queryPayload.post_town,
                    post_code: queryPayload.post_code,
                    postcode: queryPayload.post_code,
                    postCode: queryPayload.post_code,
                    
                    // Previous addresses
                    previousAddress: queryPayload.previousAddress,
                    previousPreviousAddress: queryPayload.previousPreviousAddress,
                    
                    // Valifi data - CRITICAL: Pass the entire response
                    valifiResponse: valifiResponse,
                    identityScore: 0,  // /query doesn't return this
                    identityVerified: true,  // Assume verified for batch
                    
                    // Lenders
                    accounts: accounts,
                    foundLenders: accounts,
                    additionalLenders: [],
                    
                    // Consents (standard batch defaults)
                    belmondChoiceConsent: true,
                    choiceReason: "Comprehensive",
                    otherReasonText: "",
                    existingRepresentationConsent: "No",
                    selectedProfessionalReps: [],
                    mammothPromotionsConsent: false,
                    motorFinanceConsent: true,
                    irresponsibleLendingConsent: true,
                    disengagementReason: "",
                    disengagementOtherText: "",
                    
                    // Signature & PDF
                    signatureBase64: "",
                    pdfUrl: pdfUrl,
                    
                    // Batch flags - CRITICAL
                    skipFLG: true,
                    skip_flg: true,
                    tlwSolicitorsSelected: false,
                    
                    // Tracking
                    campaign: campaign,
                    clientIp: "127.0.0.1",
                    session_id: `batch_${Date.now()}_${idxLabel}`,
                    source: "batch_import",
                    medium: "csv"
                };
                
                // ===== Step 3: Call /upload_summary =====
                log(`[${idxLabel}] ‚Üí Calling /upload_summary...`);
                
                const uploadResp = await fetch(`${baseUrl}/upload_summary`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(summary)
                });
                
                if (!uploadResp.ok) {
                    const errText = await uploadResp.text();
                    throw new Error(`/upload_summary failed: ${uploadResp.status} - ${errText}`);
                }
                
                const uploadResult = await uploadResp.json();
                const claimId = uploadResult.claim_id || "?";
                
                log(`[${idxLabel}] ‚úì Success! Claim ID: ${claimId}, Lenders: ${accounts.length}`, "success");
                
                results.push({
                    index: idxLabel,
                    first_name: record.first_name,
                    last_name: record.last_name,
                    status: "OK",
                    claim_id: claimId,
                    lenders: accounts.length
                });
                
            } catch (err) {
                log(`[${idxLabel}] Error: ${err.message}`, "error");
                results.push({
                    index: idxLabel,
                    first_name: record.first_name || "",
                    last_name: record.last_name || "",
                    status: "ERROR",
                    error: err.message
                });
            }
            
            // Delay between records
            if (i < limit - 1 && !stopRequested) {
                await new Promise(res => setTimeout(res, delayMs));
            }
        }
        
        // Complete
        log("‚îÄ".repeat(50));
        const okCount = results.filter(r => r.status === "OK").length;
        const errCount = results.filter(r => r.status === "ERROR").length;
        const skipCount = results.filter(r => r.status === "SKIPPED").length;
        log(`Batch complete: ${okCount} OK, ${errCount} errors, ${skipCount} skipped`);
        
        renderResults(results);
        
        isRunning = false;
        document.getElementById("runBatchBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
    }

    function renderResults(results) {
        const container = document.getElementById("resultsContainer");
        if (!results.length) {
            container.textContent = "No results yet.";
            return;
        }
        
        const okCount = results.filter(r => r.status === "OK").length;
        const errCount = results.filter(r => r.status === "ERROR").length;
        const skipCount = results.filter(r => r.status === "SKIPPED").length;
        
        let html = `<div style="margin-bottom: 10px;">
            <span class="badge badge-ok">${okCount} OK</span>
            <span class="badge badge-error">${errCount} Errors</span>
            <span class="badge badge-skip">${skipCount} Skipped</span>
        </div>`;
        
        html += `<div style="max-height: 300px; overflow: auto;">`;
        html += `<table id="resultsTable"><thead><tr>
            <th>#</th><th>First</th><th>Last</th><th>Status</th><th>Claim ID</th><th>Lenders</th><th>Error</th>
        </tr></thead><tbody>`;
        
        results.forEach(r => {
            const statusClass = r.status === "OK" ? "badge-ok" : r.status === "SKIPPED" ? "badge-skip" : "badge-error";
            html += `<tr>
                <td>${r.index}</td>
                <td>${r.first_name}</td>
                <td>${r.last_name}</td>
                <td><span class="badge ${statusClass}">${r.status}</span></td>
                <td>${r.claim_id || ""}</td>
                <td>${r.lenders || ""}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${r.error || ""}</td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    // ===== Event Listeners =====
    document.getElementById("runBatchBtn").addEventListener("click", runBatch);
    
    document.getElementById("stopBtn").addEventListener("click", function() {
        stopRequested = true;
        log("Stop requested - will halt after current record...", "warn");
    });
    </script>
</body>
</html>