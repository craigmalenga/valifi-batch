<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Valifi: TransUnion Credit Report</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .container { max-width: 800px; margin: auto; padding: 20px; }
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 2rem;
      align-items: start;
    }
    form h2 { grid-column: span 2; margin-top: 1.5rem; }
    .form-group { display: flex; flex-direction: column; }
    .lookup-postcode, #address_error, #clear_btn, button[type="submit"] {
      grid-column: span 2;
    }
    .lookup-postcode {
      display: flex; gap: 0.5rem; align-items: flex-end;
    }
    #address_error { color: #b00; display: none; }
    @media (max-width:600px) {
      form { grid-template-columns: 1fr; }
      .lookup-postcode, #address_error, #clear_btn, button[type="submit"] {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Valifi: TransUnion Credit Report</h1>

    <form id="searchForm" method="post" action="/query">
      <!-- 1) Name & DOB -->
      <div class="form-group"><label for="title">Title</label>
        <input type="text" id="title" name="title" placeholder="Mr / Mrs / Ms / Dr"/>
      </div>
      <div class="form-group"><label for="first_name">First Name *</label>
        <input type="text" id="first_name" name="firstName" required/>
      </div>
      <div class="form-group"><label for="middle_name">Middle Name</label>
        <input type="text" id="middle_name" name="middleName"/>
      </div>
      <div class="form-group"><label for="last_name">Last Name *</label>
        <input type="text" id="last_name" name="lastName" required/>
      </div>
      <div class="form-group"><label for="date_of_birth">Date of Birth *</label>
        <input type="text" id="date_of_birth" name="dateOfBirth" placeholder="YYYY-MM-DD" required/>
      </div>

      <!-- 2) Current Address -->
      <h2>Current Address *</h2>
      <div class="form-group"><label for="flat">Flat / Unit</label>
        <input type="text" id="flat" name="flat" placeholder="e.g. 1" required/>
      </div>
      <div class="form-group"><label for="street">Street *</label>
        <input type="text" id="street" name="street" placeholder="e.g. Example Street" required/>
      </div>
      <div class="form-group"><label for="post_town">Post Town *</label>
        <input type="text" id="post_town" name="postTown" placeholder="e.g. TEST TOWN" required/>
      </div>
      <div class="form-group"><label for="post_code">Post Code *</label>
        <input type="text" id="post_code" name="postCode" placeholder="e.g. AB1 2CD" required/>
      </div>

      <!-- 3) OR lookup by postcode -->
      <div class="form-group"><em>Or look up by postcode:</em></div>
      <div class="form-group lookup-postcode">
        <input type="text" id="lookup_postcode" placeholder="Enter postcode‚Ä¶"/>
        <button type="button" id="address_lookup_btn">Find Address</button>
      </div>
      <div class="form-group" id="address_container" style="display:none;">
        <label for="address_select">Select Address</label>
        <select id="address_select" name="address_select">
          <option value="">Pick an address‚Ä¶</option>
        </select>
      </div>
      <div id="address_error">Failed to lookup address</div>

      <!-- 4) Mobile + OTP -->
      <h2>Mobile Verification *</h2>
      <div class="form-group">
        <label for="mobile">Mobile Number</label>
        <input type="text" id="mobile" name="mobile" required/>
        <button type="button" id="send_otp">Send OTP</button>
      </div>

      <!-- Make this always visible now, so we can debug it -->
      <div class="form-group" id="otp_group">
        <label for="otp">Enter OTP</label>
        <input type="text" id="otp" name="otp"/>
        <button type="button" id="verify_otp">Verify OTP</button>
        <span id="otp_status"></span>
      </div>

      <!-- 5) Actions -->
      <button type="button" id="clear_btn">Clear All</button>
      <button type="submit" disabled>Get TransUnion Report</button>
    </form>

    <div id="result"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const lookupBtn  = document.getElementById('address_lookup_btn');
    const addrSel    = document.getElementById('address_select');
    const addrCont   = document.getElementById('address_container');
    const addrErr    = document.getElementById('address_error');
    const sendOtpBtn = document.getElementById('send_otp');
    const verifyBtn  = document.getElementById('verify_otp');
    const otpGroup   = document.getElementById('otp_group');
    const submitBtn  = document.querySelector('button[type="submit"]');
    const clearBtn   = document.getElementById('clear_btn');

    // Clear-all
    clearBtn.addEventListener('click', () => {
      document.getElementById('searchForm').reset();
      addrCont.style.display = 'none';
      addrErr.style.display  = 'none';
      otpGroup.style.display = 'block';
      otpGroup.querySelector('#otp_status').textContent = '';
      submitBtn.disabled = true;
    });

    // Address lookup (POST, matches your Postman)
    lookupBtn.addEventListener('click', async () => {
      alert('üîç [DEBUG] Find Address clicked');
      console.log('[DEBUG] Fetching /lookup-address');
      const pc = document.getElementById('lookup_postcode').value.trim();
      addrErr.style.display = 'none';
      if (!pc) { alert('Please enter a postcode'); return; }

      try {
        const res  = await fetch('/lookup-address', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ postCode: pc })
        });
        console.log('[DEBUG] lookup-address status:', res.status);
        const data = await res.json();
        console.log('[DEBUG] lookup-address JSON:', data);
        if (!res.ok) {
          addrErr.textContent = data.error || 'Lookup failed';
          addrErr.style.display = 'block';
          return;
        }

        // Populate dropdown: use name or flat, then street1, postTown
        addrSel.innerHTML = '<option value="">Pick an address‚Ä¶</option>';
        (data.addresses || []).forEach(a => {
          const o = document.createElement('option');
          o.value = JSON.stringify(a);
          const label = a.name || a.flat || '';
          o.textContent = `${label} ${a.street1}, ${a.postTown}`;
          addrSel.appendChild(o);
        });
        addrCont.style.display = 'block';
      } catch (err) {
        console.error('[DEBUG] lookup-address error', err);
        addrErr.textContent = 'Network error';
        addrErr.style.display = 'block';
      }
    });

    // On address select ‚Üí fill form fields
    addrSel.addEventListener('change', e => {
      const a = JSON.parse(e.target.value || '{}');
      if (!a.name && !a.flat) return;
      document.getElementById('flat').value      = a.name  || a.flat  || '';
      document.getElementById('street').value    = a.street1         || '';
      document.getElementById('post_town').value = a.postTown        || '';
      document.getElementById('post_code').value = a.postcode        || '';
    });

    // Send OTP
    sendOtpBtn.addEventListener('click', async () => {
      alert('üì© [DEBUG] Send OTP clicked');
      console.log('[DEBUG] Fetching /otp/request');
      const mobile = document.getElementById('mobile').value.trim();
      if (!mobile) { alert('Please enter a mobile number'); return; }

      try {
        const res = await fetch('/otp/request', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ mobile })
        });
        console.log('[DEBUG] otp/request status:', res.status);
        const data = await res.json();
        console.log('[DEBUG] otp/request JSON:', data);
        if (!res.ok) {
          alert(`OTP request failed: ${data.error||res.status}`);
          return;
        }
        otpGroup.style.display = 'block';
      } catch (err) {
        console.error('[DEBUG] otp/request error', err);
        alert('Network error sending OTP');
      }
    });

    // Verify OTP
    verifyBtn.addEventListener('click', async () => {
      alert('üîê [DEBUG] Verify OTP clicked');
      console.log('[DEBUG] Fetching /otp/verify');
      const mobile = document.getElementById('mobile').value.trim();
      const code   = document.getElementById('otp').value.trim();
      if (!code) { alert('Please enter the 6-digit OTP'); return; }

      try {
        const res  = await fetch('/otp/verify', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ mobile, code })
        });
        console.log('[DEBUG] otp/verify status:', res.status);
        const data = await res.json();
        console.log('[DEBUG] otp/verify JSON:', data);

        const ok = data.data?.result === 'PASS';
        document.getElementById('otp_status').textContent = ok ? '‚úî Verified' : '‚ùå Failed';
        if (ok) submitBtn.disabled = false;
      } catch (err) {
        console.error('[DEBUG] otp/verify error', err);
        alert('Network error verifying OTP');
      }
    });

    // Final form submit ‚Üí /query
    const form = document.getElementById('searchForm');
    form.addEventListener('submit', async e => {
      e.preventDefault();
      submitBtn.disabled = true;

      const payload = {
        title:           document.getElementById('title').value.trim(),
        firstName:       document.getElementById('first_name').value.trim(),
        middleName:      document.getElementById('middle_name').value.trim(),
        lastName:        document.getElementById('last_name').value.trim(),
        dateOfBirth:     document.getElementById('date_of_birth').value.trim(),
        flat:            document.getElementById('flat').value.trim(),
        street:          document.getElementById('street').value.trim(),
        postTown:        document.getElementById('post_town').value.trim(),
        postCode:        document.getElementById('post_code').value.trim(),
        clientReference: 'report'
      };

      try {
        const res    = await fetch('/query', {
          method:  'POST',
          headers: {'Content-Type':'application/json'},
          body:    JSON.stringify(payload)
        });
        const result = await res.json();
        document.getElementById('result').textContent = JSON.stringify(result, null, 2);
      } catch(err) {
        document.getElementById('result').textContent = 'Error: ' + err;
      } finally {
        submitBtn.disabled = false;
      }
    });
  });
  </script>
</body>
</html>
