<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .container { max-width: 800px; margin: auto; padding: 20px; }
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 2rem;
      align-items: start;
    }
    form h2 { grid-column: span 2; margin-top: 1.5rem; }
    .form-group { display: flex; flex-direction: column; }
    .lookup-postcode, #address_error, #clear_btn, button[type="submit"] {
      grid-column: span 2;
    }
    .lookup-postcode {
      display: flex; gap: 0.5rem; align-items: flex-end;
    }
    #address_error { color: #b00; display: none; }
    @media (max-width:600px) {
      form { grid-template-columns: 1fr; }
      .lookup-postcode, #address_error, #clear_btn, button[type="submit"] {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <form id="searchForm" autocomplete="on">
      <!-- === STEP 1: Personal Info === -->
      <div class="form-step" id="step1">
        <h2 class="section-heading">Ready to Roll? Who Financed the Vehicle?</h2>

        <div class="form-group">
          <label>Title *</label>
          <div class="title-button-group" id="title_buttons">
            <button type="button" data-value="Mr">Mr</button>
            <button type="button" data-value="Mrs">Mrs</button>
            <button type="button" data-value="Miss">Miss</button>
            <button type="button" data-value="Ms">Ms</button>
            <button type="button" data-value="Dr">Dr</button>
            <button type="button" data-value="Lady">Lady</button>
            <button type="button" data-value="Sir">Sir</button>
          </div>
          <input type="hidden" id="title" name="title" required />
        </div>

        <div class="form-group">
          <label for="first_name">First Name (as on documents) *</label>
          <input type="text" id="first_name" required>
        </div>

        <div class="form-group">
          <label for="middle_name">Middle Name(s) – optional</label>
          <input type="text" id="middle_name">
        </div>

        <div class="form-group">
          <label for="last_name">Last Name *</label>
          <input type="text" id="last_name" required>
        </div>

        <div class="form-group">
          <label for="dob_day">Date of Birth *</label>
          <div style="display:flex; gap:0.5rem;">
            <select id="dob_day" required>
              <option value="">Day</option>
            </select>
            <select id="dob_month" required>
              <option value="">Month</option>
            </select>
            <input type="text" id="dob_year" placeholder="YYYY" maxlength="4" required />
          </div>
        </div>

        <div class="button-row">
          <button type="button" class="button-left" id="clear_step1">Clear Data</button>
          <button type="button" class="button-right" id="next_to_step2">Proceed</button>
        </div>
      </div>

      <!-- === STEP 2: Address === -->
      <div class="form-step" id="step2" style="display:none;">
        <div class="step-title">What’s your address?</div>

        <div style="display:flex; gap:0.5rem;">
          <input type="text" id="lookup_postcode" placeholder="Enter postcode…" style="flex:1;" />
          <button type="button" class="button-right" id="address_lookup_btn">Find Address</button>
        </div>

        <div id="address_container" style="margin-top: 1rem; display:none;">
          <label for="address_select">Select Address</label>
          <select id="address_select" name="address_select" style="width: 100%;">
            <option value="">Pick an address…</option>
          </select>
        </div>

        <div id="address_error" style="color: red; display: none; margin-top:0.5rem;"></div>

        <div class="form-group"><label for="flat">Flat / Unit</label>
          <input type="text" id="flat" name="flat" placeholder="e.g. 1" required/>
        </div>
        <div class="form-group"><label for="street">Street *</label>
          <input type="text" id="street" name="street" placeholder="e.g. Example Street" required/>
        </div>
        <div class="form-group"><label for="post_town">Post Town *</label>
          <input type="text" id="post_town" name="postTown" placeholder="e.g. TEST TOWN" required/>
        </div>
        <div class="form-group"><label for="post_code">Post Code *</label>
          <input type="text" id="post_code" name="postCode" placeholder="e.g. AB1 2CD" required/>
        </div>

        <div class="button-row">
          <button type="button" class="button-left" id="back_to_step1">Go Back</button>
          <button type="button" class="button-right" id="next_to_step3">Proceed</button>
        </div>
      </div>

      <!-- === STEP 3: Mobile Entry === -->
      <div class="form-step" id="step3" style="display:none;">
        <div class="step-title">Mobile Verification</div>

        <div class="form-group">
          <label for="mobile">Mobile Number *</label>
          <input type="tel" id="mobile" name="mobile" required autocomplete="tel">
          <button type="button" class="button-right" id="send_otp">Send OTP</button>
        </div>

        <div class="button-row">
          <button type="button" class="button-left" id="back_to_step2">Go Back</button>
          <button type="button" class="button-right" id="next_to_step4">Proceed</button>
        </div>
      </div>

      <!-- === STEP 4: OTP Verification === -->
      <div class="form-step" id="step4" style="display:none;">
        <div class="step-title">Verify OTP Code</div>

        <div class="form-group" id="otp_group">
          <label for="otp">Enter OTP *</label>
          <input type="text" id="otp" name="otp" autocomplete="one-time-code" inputmode="numeric">
          <button type="button" class="button-right" id="verify_otp">Verify OTP</button>
          <span id="otp_status"></span>
        </div>

        <div class="button-row">
          <button type="button" class="button-left" id="back_to_step3">Go Back</button>
          <button type="button" class="button-right" id="next_to_step5">Proceed</button>
        </div>
      </div>

      <!-- === STEP 5: Submit Final === -->
      <div class="form-step" id="step5" style="display:none;">
        <div class="step-title">Review and Submit</div>

        <p style="text-align:center;">Click below to retrieve your credit report.</p>

        <div class="button-row">
          <button type="button" class="button-left" id="back_to_step4">Go Back</button>
          <button type="submit" class="button-right">Get Report</button>
        </div>
      </div>
    </form>
    <div id="result"></div>
    <div id="flg_status" style="margin-top:10px; color:#006; font-weight:bold;"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Step navigation logic
    const showStep = (idToShow) => {
      document.querySelectorAll('.form-step').forEach(div => {
        div.style.display = (div.id === idToShow) ? 'block' : 'none';
      });
    };

    document.getElementById('next_to_step2')?.addEventListener('click', () => showStep('step2'));
    document.getElementById('back_to_step1')?.addEventListener('click', () => showStep('step1'));
    document.getElementById('next_to_step3')?.addEventListener('click', () => showStep('step3'));
    document.getElementById('back_to_step2')?.addEventListener('click', () => showStep('step2'));
    document.getElementById('next_to_step4')?.addEventListener('click', () => showStep('step4'));
    document.getElementById('back_to_step3')?.addEventListener('click', () => showStep('step3'));
    document.getElementById('next_to_step5')?.addEventListener('click', () => showStep('step5'));
    document.getElementById('back_to_step4')?.addEventListener('click', () => showStep('step4'));

    document.getElementById('clear_step1')?.addEventListener('click', () => {
      document.getElementById('searchForm').reset();
      showStep('step1');
    });

    // Populate DOB dropdowns
    const daySel = document.getElementById('dob_day');
    const monthSel = document.getElementById('dob_month');

    if (daySel && monthSel) {
      for (let i = 1; i <= 31; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        daySel.appendChild(opt);
      }

      ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
        .forEach((m, i) => {
          const opt = document.createElement('option');
          opt.value = i + 1;
          opt.textContent = m;
          monthSel.appendChild(opt);
        });
    }

    // Manual address toggle
    const manualBtn = document.getElementById('enter_manual_btn');
    const manualAddress = document.getElementById('manual_address');
    if (manualBtn && manualAddress) {
      manualBtn.addEventListener('click', () => {
        manualAddress.style.display = 'block';
      });
    }

    // Title button group logic
    document.querySelectorAll('#title_buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#title_buttons button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('title').value = btn.dataset.value;
      });
    });

    // Clear-all
    const clearBtn = document.getElementById('clear_btn');
    const addrCont = document.getElementById('address_container');
    const addrErr = document.getElementById('address_error');
    const otpGroup = document.getElementById('otp_group');
    const submitBtn = document.querySelector('button[type="submit"]');

    clearBtn?.addEventListener('click', () => {
      document.getElementById('searchForm').reset();
      addrCont.style.display = 'none';
      addrErr.style.display = 'none';
      otpGroup.style.display = 'block';
      otpGroup.querySelector('#otp_status').textContent = '';
      submitBtn.disabled = true;
    });

    // Address lookup
    document.getElementById('address_lookup_btn')?.addEventListener('click', async () => {
      const pc = document.getElementById('lookup_postcode').value.trim();
      const addrSel = document.getElementById('address_select');
      addrErr.style.display = 'none';
      addrSel.innerHTML = '<option value="">Pick an address…</option>';

      if (!pc) return alert('Please enter a postcode');

      try {
        const res = await fetch('/lookup-address', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ postCode: pc })
        });
        const data = await res.json();

        if (!res.ok || !Array.isArray(data.addresses)) throw new Error(data.error || 'Lookup failed');
        if (data.addresses.length === 0) {
          addrCont.style.display = 'none';
          addrErr.textContent = 'No addresses found';
          addrErr.style.display = 'block';
          return;
        }

        data.addresses.forEach(a => {
          const opt = document.createElement('option');
          opt.value = JSON.stringify(a);
          const label = a.name || a.flat || a.house || a.number || '';
          opt.textContent = `${label} ${a.street1}, ${a.postTown}`;
          addrSel.appendChild(opt);
        });

        addrCont.style.display = 'block';
      } catch (err) {
        addrCont.style.display = 'none';
        addrErr.textContent = err.message || 'Network error';
        addrErr.style.display = 'block';
      }
    });

    // Populate fields after selecting address
    document.getElementById('address_select')?.addEventListener('change', e => {
      const a = JSON.parse(e.target.value || '{}');
      if (!a.name && !a.flat && !a.house && !a.number) return;
      const flatVal = a.name || a.flat || a.house || a.number || '';
      document.getElementById('flat').value = flatVal;
      document.getElementById('street').value = a.street1 || '';
      document.getElementById('post_town').value = a.postTown || '';
      document.getElementById('post_code').value = a.postcode || '';
      manualAddress.style.display = 'block';
    });

    // OTP request
    document.getElementById('send_otp')?.addEventListener('click', async () => {
      const mobileInput = document.getElementById('mobile');
      const sendOtpBtn = document.getElementById('send_otp');
      const verifyBtn = document.getElementById('verify_otp');
      const overlay = document.getElementById('overlay');
      const overlayMsg = document.getElementById('overlay_msg');

      const mobile = mobileInput.value.replace(/\D/g, '');
      if (!mobile || mobile.length < 10) {
        alert('Please enter a valid mobile number');
        return;
      }

      sendOtpBtn.disabled = true;
      verifyBtn.disabled = true;
      overlayMsg.textContent = 'Code being sent to your mobile… please wait';
      overlay.style.display = 'flex';

      try {
        const res = await fetch('/otp/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mobile })
        });
        const data = await res.json();
        console.log('[DEBUG] OTP response:', data);

        if (!res.ok || !data?.data?.result) {
          throw new Error(data?.error || 'OTP send failed');
        }

        document.getElementById('otp_group').style.display = 'block';
        verifyBtn.disabled = false;
      } catch (err) {
        console.error('OTP send error:', err);
        alert(`OTP send failed: ${err.message}`);
      } finally {
        overlay.style.display = 'none';
        sendOtpBtn.disabled = false;
      }
    });


    // OTP verify
    document.getElementById('verify_otp')?.addEventListener('click', async () => {
      const mobile = document.getElementById('mobile').value.replace(/\D/g, '');
      const code = document.getElementById('otp').value.replace(/\D/g, '');
      if (!mobile || !code) return alert('Please complete both mobile and OTP fields');

      const verifyBtn = document.getElementById('verify_otp');
      verifyBtn.disabled = true;
      document.getElementById('overlay_msg').textContent = 'Verifying OTP code… please wait';
      document.getElementById('overlay').style.display = 'flex';

      try {
        const res = await fetch('/otp/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mobile, code })
        });
        const data = await res.json();
        const ok = data.data?.result === 'PASS';
        const statusEl = document.getElementById('otp_status');
        statusEl.textContent = ok ? '✔ Verified' : '❌ Failed';
        statusEl.classList.toggle('verified', ok);
        if (ok) submitBtn.disabled = false;
      } catch (err) {
        alert(`OTP verification failed: ${err.message}`);
      } finally {
        document.getElementById('overlay').style.display = 'none';
        verifyBtn.disabled = false;
      }
    });

    // Form submit
    const form = document.getElementById('searchForm');
    form.addEventListener('submit', async e => {
      e.preventDefault();
      submitBtn.disabled = true;

      const payload = {
        title: document.getElementById('title').value.trim(),
        firstName: document.getElementById('first_name').value.trim(),
        middleName: document.getElementById('middle_name').value.trim(),
        lastName: document.getElementById('last_name').value.trim(),
        dateOfBirth: `${document.getElementById('dob_year').value.trim()}-${String(document.getElementById('dob_month').value).padStart(2,'0')}-${String(document.getElementById('dob_day').value).padStart(2,'0')}`,
        flat: document.getElementById('flat').value.trim(),
        street: document.getElementById('street').value.trim(),
        postTown: document.getElementById('post_town').value.trim(),
        postCode: document.getElementById('post_code').value.trim(),
        clientReference: 'report'
      };

      try {
        const res = await fetch('/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        const summary = result.data?.summaryReport || result.data;
        document.getElementById('result').textContent = JSON.stringify(summary, null, 2);

        // Send to FLG
        try {
          const flgRes = await fetch('/upload_summary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(summary)
          });
          const flgData = await flgRes.json();
          document.getElementById('flg_status').textContent = flgRes.ok
            ? 'FLG upload succeeded'
            : `FLG upload failed: ${flgData.error || flgRes.status}`;
        } catch (err) {
          console.error('[DEBUG] Error posting to FLG:', err);
          document.getElementById('flg_status').textContent = 'Error posting to FLG, see console';
        }

        const b64 = result.data?.pdfReport;
        if (b64) {
          const binary = atob(b64);
          const u8 = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            u8[i] = binary.charCodeAt(i);
          }
          const blob = new Blob([u8], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'transunion_report.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

      } catch (err) {
        console.error(err);
        document.getElementById('result').textContent = 'Error: ' + err;
      } finally {
        submitBtn.disabled = false;
      }
    });

  });
  </script>


  
</body>
</html>
